def docker_image_tags = []

pipeline {
    agent any
    stages {
        stage('Select Build') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker_hub', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh "docker login --username ${USERNAME} --password ${PASSWORD}"
                    script {
                        //get tags from docker hub
                        docker_image_tags = sh script: "wget -q https://registry.hub.docker.com/v1/repositories/rparias/springtest/tags -O -  | sed -e 's/[][]//g' -e 's/\"//g' -e 's/ //g' | tr '}' '\n'  | awk -F: '{print \$3}'", returnStdout:true
                    }
                    timeout(time: 3, unit: 'HOURS') {
                        script {
                            VERSION = input(
                                message: 'Please select a build to deploy',
                                parameters: [
                                    choice(
                                        name: 'VERSION',
                                        choices: docker_image_tags,
                                        description: 'List of successful builds, sorted by descending build date')
                                ]
                            )
                        }
                    }
                    echo "tag version: ${VERSION}"
                }
            }
        }
        stage('Deploy to STG') {
            steps {
                sh "./deploy-app.sh 10.211.55.8 ${VERSION}"
            }
        }
    }
}
