def docker_image_tags = []

pipeline {
    agent any
    stages {
        stage('Select Build') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker_hub', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh "docker login --username ${USERNAME} --password ${PASSWORD}"
                    script {
                        //get tags from docker hub
                        docker_image_tags = sh script: "wget -q https://registry.hub.docker.com/v1/repositories/rparias/springtest/tags -O -  | sed -e 's/[][]//g' -e 's/\"//g' -e 's/ //g' | tr '}' '\n'  | awk -F: '{print \$3}'", returnStdout:true
                    }
                    timeout(time: 3, unit: 'HOURS') {
                        script {
                            selectedTag = input(
                                message: 'Please select a build to deploy',
                                parameters: [
                                    choice(
                                        name: 'VERSION',
                                        choices: docker_image_tags,
                                        description: 'List of successful builds, sorted by descending build date')
                                ]
                            )
                        }
                    }
                    echo "tag version: ${VERSION}"
                }
            }
        }
        stage('Deploy to STG') {
            steps {
                sh 'scp -i ~/.ssh/id_rsa ./docker-compose-app.yml stop-spring-app.sh ronaldarias@10.211.55.7:/home/ronaldarias/server'
                sh 'ssh -i ~/.ssh/id_rsa ronaldarias@10.211.55.7 "export BUILD_NUMBER=${VERSION} && export APP_NAME=spring-app && cd server && sh stop-spring-app.sh && docker-compose -f docker-compose-app.yml up -d"'
            }
        }
    }
}
